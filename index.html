<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>‚öîÔ∏è CAESAR Screen Recorder</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Cinzel:wght@600;700&display=swap" rel="stylesheet">

<style>
body{
  margin:0;
  font-family:'Poppins',sans-serif;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
  background:linear-gradient(135deg,#8e2de2,#c31432,#f7971e,#ffd200);
  background-size:400% 400%;
  animation:bg 18s ease infinite;
}

@keyframes bg{
  0%{background-position:0% 50%}
  50%{background-position:100% 50%}
  100%{background-position:0% 50%}
}

.app{
  width:100%;
  max-width:1000px;
  background:rgba(0,0,0,0.88);
  border-radius:32px;
  padding:48px;
  box-shadow:0 40px 100px rgba(0,0,0,.95);
  color:#fff;
  border:1px solid rgba(255,215,0,.15);
}

h1{
  margin:0;
  text-align:center;
  font-family:'Cinzel',serif;
  font-size:2.8rem;
  letter-spacing:2px;
  background:linear-gradient(90deg,#ffd700,#ffb347,#c9a227);
  background-clip:text;
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  text-shadow:0 0 30px rgba(255,215,0,.25);
}

.subtitle{
  text-align:center;
  margin-top:8px;
  font-size:.95rem;
  letter-spacing:1px;
  opacity:.8;
}

.controls{
  display:flex;
  justify-content:center;
  gap:24px;
  margin-top:36px;
}

button{
  padding:18px 44px;
  font-size:1.1rem;
  font-weight:600;
  border:none;
  border-radius:22px;
  cursor:pointer;
  transition:.3s;
  box-shadow:0 12px 30px rgba(0,0,0,.5);
}

.start{
  background:linear-gradient(135deg,#36d1dc,#5b86e5);
  color:white;
}

.start:hover{transform:translateY(-2px);}

.start:disabled{
  opacity:.5;
  cursor:not-allowed;
}

.stop{
  background:linear-gradient(135deg,#ff416c,#ff4b2b);
  color:white;
}

.stop:hover{transform:translateY(-2px);}

.stop:disabled{
  opacity:.35;
  cursor:not-allowed;
  box-shadow:none;
  filter:grayscale(40%);
}

.status{
  text-align:center;
  margin-top:18px;
  font-weight:600;
  letter-spacing:.5px;
}

.hint{
  margin-top:26px;
  padding:16px;
  border-radius:18px;
  background:linear-gradient(135deg,rgba(255,215,0,.08),rgba(255,255,255,.03));
  text-align:center;
  font-size:.9rem;
  border:1px solid rgba(255,215,0,.15);
}

video{
  width:100%;
  margin-top:34px;
  border-radius:24px;
  display:none;
  box-shadow:0 25px 60px rgba(0,0,0,.8);
}
</style>
</head>

<body>

<div class="app">
  <h1>‚öîÔ∏è CAESAR</h1>
  <div class="subtitle">Imperial Screen Recording ‚Ä¢ Maximum Quality</div>

  <div class="controls">
    <button id="startBtn" class="start">Start Recording</button>
    <button id="stopBtn" class="stop" disabled>Stop</button>
  </div>

  <div class="hint">
    üëâ Choose <b>Entire Screen</b> and enable <b>System Audio</b><br>
    Crisp video ‚Ä¢ Powerful sound ‚Ä¢ Imperial quality
  </div>

  <div class="status" id="status">Idle</div>
  <video id="preview" controls></video>
</div>

<script>
let recorder;
let chunks=[];
let audioCtx;
let micStream;
let analyser;
let voiceDetector;
let gameAudioGain;
let isSpeaking=false;
let voiceThreshold=0.02;
let smoothingFactor=0.8;

const startBtn=document.getElementById("startBtn");
const stopBtn=document.getElementById("stopBtn");
const statusEl=document.getElementById("status");
const preview=document.getElementById("preview");

startBtn.onclick=async()=>{
  try{
    const screenStream=await navigator.mediaDevices.getDisplayMedia({
      video:{
        frameRate:60,
        width:window.screen.width,
        height:window.screen.height
      },
      audio:true
    });

    micStream = await navigator.mediaDevices.getUserMedia({
      audio:{
        channelCount:2,
        sampleRate:48000,
        echoCancellation:false,
        noiseSuppression:false,
        autoGainControl:false
      }
    });

    audioCtx=new AudioContext();
    const source=audioCtx.createMediaStreamSource(screenStream);
    const micSource=audioCtx.createMediaStreamSource(micStream);

    // Voice detection setup
    analyser=audioCtx.createAnalyser();
    analyser.fftSize=256;
    micSource.connect(analyser);

    // Game audio gain (for ducking)
    gameAudioGain=audioCtx.createGain();
    gameAudioGain.gain.value=1.0;

    // Microphone gain and processing
    const micGain=audioCtx.createGain();
    micGain.gain.value=2.0; // Boost mic moderately to make it dominant

    const compressor=audioCtx.createDynamicsCompressor();
    compressor.threshold.value=-12;
    compressor.knee.value=8;
    compressor.ratio.value=6;
    compressor.attack.value=0.003;
    compressor.release.value=0.1;

    const destination=audioCtx.createMediaStreamDestination();

    // Route game audio through duckable gain
    source.connect(gameAudioGain);
    gameAudioGain.connect(compressor);

    // Route processed mic directly
    micSource.connect(micGain);
    micGain.connect(compressor);
    compressor.connect(destination);

    // Start voice detection
    startVoiceDetection();

    const finalStream=new MediaStream([
      ...screenStream.getVideoTracks(),
      ...destination.stream.getAudioTracks()
    ]);

    recorder=new MediaRecorder(finalStream,{
      mimeType:"video/webm;codecs=vp8,opus",
      videoBitsPerSecond:15000000,
      audioBitsPerSecond:320000
    });

    chunks=[];
    recorder.ondataavailable=e=>e.data.size&&chunks.push(e.data);

    recorder.onstop=()=>{
      const blob=new Blob(chunks,{type:"video/webm"});
      const url=URL.createObjectURL(blob);
      preview.src=url;
      preview.style.display="block";
      preview.play();

      const a=document.createElement("a");
      a.href=url;
      a.download="caesar-recording.webm";
      a.click();

      startBtn.disabled=false;
      stopBtn.disabled=true;
      statusEl.textContent="Stopped";
    };

    recorder.start();
    startBtn.disabled=true;
    stopBtn.disabled=false;
    statusEl.textContent="Recording‚Ä¶";

    screenStream.getVideoTracks()[0].onended=()=>{
      if(recorder.state!=="inactive") recorder.stop();
    }

  }catch(err){
    alert("Recording failed: "+err.message);
  }
};

stopBtn.onclick=()=>{
  if(recorder && recorder.state!=="inactive") recorder.stop();
  if(voiceDetector) cancelAnimationFrame(voiceDetector);
};

function startVoiceDetection(){
  const bufferLength=analyser.frequencyBinCount;
  const dataArray=new Uint8Array(bufferLength);
  
  function detect(){
    analyser.getByteFrequencyData(dataArray);
    
    // Calculate RMS (volume) of microphone
    let sum=0;
    for(let i=0;i<bufferLength;i++){
      sum+=dataArray[i]*dataArray[i];
    }
    const rms=Math.sqrt(sum/bufferLength)/255;
    
    // Smooth the detection to avoid rapid switching
    const smoothedRms=isSpeaking ? rms*smoothingFactor + (1-smoothingFactor)*voiceThreshold : rms;
    
    // Detect voice activity
    const wasSpeaking=isSpeaking;
    isSpeaking=smoothedRms>voiceThreshold;
    
    // Apply ducking when speaking
    if(isSpeaking && !wasSpeaking){
      // Just started speaking - duck game audio less aggressively
      gameAudioGain.gain.setTargetAtTime(0.4, audioCtx.currentTime, 0.02);
      statusEl.textContent="Recording‚Ä¶ üé§ Speaking";
    } else if(!isSpeaking && wasSpeaking){
      // Stopped speaking - restore game audio gradually
      gameAudioGain.gain.setTargetAtTime(1.0, audioCtx.currentTime, 0.3);
      statusEl.textContent="Recording‚Ä¶";
    }
    
    // Auto-adjust threshold based on background noise
    if(!isSpeaking && smoothedRms>0.001){
      voiceThreshold=Math.min(0.05, voiceThreshold*0.999 + smoothedRms*0.001);
    }
    
    voiceDetector=requestAnimationFrame(detect);
  }
  
  detect();
}
</script>

</body>
</html>
